- route:
    id: route-b00a
    from:
      uri: kamelet:kafka-source
      id: from-d8c9
      parameters:
        topic: debezium.public.products
        bootstrapServers: kafka-cluster-kafka-bootstrap.user1-dev.svc:9092
        securityProtocol: PLAINTEXT
        user: demo
        password: demo
        autoOffsetReset: earliest
      steps:
        - to:
            uri: atlasmap:file:/etc/camel/resources/atlasmap-mapping.adm
            id: to-4fff
        - choice:
            when:
              - id: when-f008
                expression:
                  simple:
                    expression: ${body.contains("op":"u")}
                    id: simple-5b6b
                description: 'When: UPDATE'
                steps:
                  - log:
                      message: 'UPDATE: ${body}'
                      id: log-3a7c
                  - to:
                      uri: kamelet:postgresql-sink
                      id: to-ba63
                      parameters:
                        serverName: postgresql-replica.user1-dev.svc.cluster.local
                        serverPort: '5432'
                        username: demo
                        password: demo
                        query: UPDATE products SET name=:#name where id=:#id
                        databaseName: sampledb
              - id: when-21ed
                expression:
                  simple:
                    expression: ${body.contains("op":"d")}
                    id: simple-f4db
                description: 'When: DELETE'
                steps:
                  - log:
                      message: 'DELETE: ${body}'
                      id: log-5a06
                  - to:
                      uri: kamelet:postgresql-sink
                      id: to-0db8
                      parameters:
                        serverName: postgresql-replica.user1-dev.svc.cluster.local
                        serverPort: '5432'
                        username: demo
                        password: demo
                        databaseName: sampledb
                        query: DELETE from products where id=:#id
            id: choice-2d15
            otherwise:
              id: otherwise-e045
              description: 'Otherwise: CREATE'
              steps:
                - log:
                    message: '"Otherwise"'
                    id: log-90ef
                - to:
                    uri: kamelet:postgresql-sink
                    id: to-d8bb
                    parameters:
                      serverName: postgresql-replica.user1-dev.svc.cluster.local
                      serverPort: '5432'
                      username: demo
                      password: demo
                      databaseName: sampledb
                      query: INSERT INTO products (id, name) VALUES (:#id, :#name)
